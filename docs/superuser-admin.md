# Superuser Administration Guide

This document describes the Superuser role, permissions model, and the protected endpoints added for platform‑level tenant and payment management.

## Overview

- Superusers are platform‑level administrators with cross‑tenant privileges.
- Capabilities:
  - Create, list, and delete tenants
  - Manage a tenant’s `paymentHistory` (add, update, delete)
  - Set/clear a user’s role (`user` | `super`)
- Regular users remain tenant‑scoped and continue using existing RBAC permissions (`checkPermission`).

## Role Model & Auth

- JWT payload: `{ id, tenant }` (generated by `utils/generate-token.js`)
- User schema (`entities/user/user.model.js`):
  - `role: 'user' | 'super'` (default: `user`)
- Middleware guards (`middlewares/Auth.js`):
  - `authenticate` – validates JWT, attaches `req.user` and `req.tenant`
  - `checkPermission(resource, action)` – tenant‑scoped RBAC for regular users
  - `requireSuperuser` – only allows requests from `req.user.role === 'super'`

## Bootstrap: Promote a Superuser

1. Ensure `.env` has a valid `MONGO_URI`.
2. Promote an existing user by email:

   ```bash
   node scripts/make-super.js user@example.com
   ```

On success, the user’s `role` becomes `super`. Use this account to manage tenants and roles.

## Authentication

- Obtain a token via login:

  ```http
  POST /api/account/login
  Content-Type: application/json

  { "email": "user@example.com", "password": "plaintext-or-dev-pass" }
  ```

- Use the returned `accessToken` as a Bearer token:

  ```http
  Authorization: Bearer <ACCESS_TOKEN>
  ```

## Tenant Management (Superuser)

- Create tenant:
  - `POST /api/super/tenants`
  - Body fields follow `entities/tenant/tenant.model.js` (e.g., `name`, `slug`, `address`, etc.)
  - Guard: `authenticate` + `requireSuperuser`

- List tenants:
  - `GET /api/super/tenants?search=<text>&page=<n>&limit=<n>`
  - Guard: `authenticate` + `requireSuperuser`

- Delete tenant:
  - `DELETE /api/super/tenants/:id`
  - Guard: `authenticate` + `requireSuperuser`
  - Note: No cascading delete is performed. If needed, add a cleanup process before/after deletion.

- View/update current tenant (tenant‑scoped):
  - `GET /api/tenants/mytenant`
  - `PUT /api/tenants/mytenant`
  - Guard: `authenticate` (+ `checkPermission('tenant','update')` for update)
  - This remains available for tenant admins with the proper permission.

## Tenant Payment History (Superuser)

`paymentHistory` is an array of subdocuments on `Tenant`. New records include an `_id` to allow precise updates.

- Add payment:
  - `POST /api/super/tenants/:id/payments`
  - Guard: `authenticate` + `requireSuperuser`
  - Body:

    ```json
    {
      "amount": 12500,
      "paymentDate": "2025-01-10T10:00:00.000Z",
      "paymentMethod": "BankTransfer", // UPI | Card | BankTransfer | Cash
      "status": "PENDING",            // optional: SUCCESS | FAILED | PENDING
      "notes": "Invoice 123 settlement" // optional
    }
    ```

- Update payment:
  - `PUT /api/super/tenants/:id/payments/:paymentId`
  - Guard: `authenticate` + `requireSuperuser`
  - Body: any subset of fields `{ amount, paymentDate, paymentMethod, status, notes }`

- Delete payment:
  - `DELETE /api/super/tenants/:id/payments/:paymentId`
  - Guard: `authenticate` + `requireSuperuser`

Validation highlights:
- `amount` must be a non‑negative number
- `paymentMethod` ∈ { UPI, Card, BankTransfer, Cash }
- `status` ∈ { SUCCESS, FAILED, PENDING }
- `paymentDate` must be a valid date

Legacy note: older `paymentHistory` entries created before this change might be missing `_id`. New entries will have `_id`. If you need to edit legacy items, consider re‑adding them.

## User Role Management (Superuser)

- Set role:
  - `PATCH /api/users/:id/role`
  - Guard: `authenticate` + `requireSuperuser`
  - Body: `{ "role": "user" | "super" }`

Guardrails against privilege escalation:
- `POST /api/users` and `PUT /api/users/:id` ignore `role` changes unless requester is a superuser.
- Only the dedicated role endpoint allows changing roles.

## Create User In Tenant (Superuser)

- Create a user directly under a specific tenant with all permissions enabled:
  - `POST /api/super/tenants/:tenantId/users`
  - Guard: `authenticate` + `requireSuperuser`
  - Body example:

    ```json
    {
      "name": "John Admin",
      "email": "john.admin@example.com",
      "mobile": "9999999999",
      "address": "HQ",
      "password": "changeme",
      "designation": "Admin"
    }
    ```

  - Notes:
    - The `tenantId` URL param determines the tenant assignment.
    - All boolean permissions are turned on for the created user.
    - The `role` cannot be set here; use `PATCH /api/users/:id/role` to change role.

## cURL Examples

```bash
# Environment
API="http://localhost:5001/api"
TOKEN="<ACCESS_TOKEN>"   # login to obtain
TENANT_ID="<TENANT_OBJECT_ID>"
PAYMENT_ID="<PAYMENT_OBJECT_ID>"

# Create tenant (super)
curl -sS -X POST "$API/super/tenants" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Acme Logistics",
    "slug": "acme-logistics",
    "address": {"line1":"A1","state":"MH","city":"Mumbai","pincode":"400001"},
    "contactDetails": {"email":"ops@acme.com"}
  }'

# List tenants (super)
curl -sS -H "Authorization: Bearer $TOKEN" "$API/super/tenants?limit=20&page=1"

# Delete tenant (super)
curl -sS -X DELETE -H "Authorization: Bearer $TOKEN" "$API/super/tenants/$TENANT_ID"

# Add payment (super)
curl -sS -X POST "$API/super/tenants/$TENANT_ID/payments" \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"amount": 5000, "paymentDate": "2025-01-10T10:00:00.000Z", "paymentMethod": "UPI", "status": "PENDING"}'

# Update payment (super)
curl -sS -X PUT "$API/super/tenants/$TENANT_ID/payments/$PAYMENT_ID" \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"status": "SUCCESS", "notes": "Cleared on call"}'

# Delete payment (super)
curl -sS -X DELETE -H "Authorization: Bearer $TOKEN" "$API/super/tenants/$TENANT_ID/payments/$PAYMENT_ID"

# Set user role (super)
curl -sS -X PATCH "$API/users/<USER_ID>/role" \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{"role":"super"}'

# Create user in tenant (super)
curl -sS -X POST "$API/super/tenants/$TENANT_ID/users" \
  -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" \
  -d '{
    "name":"John Admin",
    "email":"john.admin@example.com",
    "mobile":"9999999999",
    "address":"HQ",
    "password":"changeme",
    "designation":"Admin"
  }'
```

## Operational Notes

- Rate limiting applies globally (`server.js`), so batch operations should be paced accordingly.
- CORS is enabled for configured origins; adjust `server.js` if your admin UI origin differs.
- Tenant deletion is powerful—ensure you keep backups and add data cleanup/cascade logic if needed.

## Implementation References

- `middlewares/Auth.js:69` – `requireSuperuser` middleware
- `entities/tenant/tenant.routes.js` – superuser‑protected tenant + payment routes
- `entities/tenant/tenant.controller.js` – payment handlers
- `entities/user/user.model.js` – `role` field
- `entities/user/user.controller.js` – role change hardening, `updateUserRole`
- `entities/user/user.routes.js` – `PATCH /:id/role`
- `scripts/make-super.js` – CLI to promote a user
